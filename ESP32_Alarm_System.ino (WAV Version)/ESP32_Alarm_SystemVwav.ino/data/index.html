<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>SYSTEM ALARM MODUL 32</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            text-align: center;
            color: white;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            font-size: 1.8em;
        }
        
        /* Tab Navigation */
        .tab-nav {
            display: flex;
            gap: 16px;
            margin-bottom: 20px;
            background: white;
            padding: 8px;
            border-radius: 16px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .tab-button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            background: #e5e7eb;
            color: #374151;
            transition: all 0.3s;
            font-size: 1em;
        }
        .tab-button.active {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
        }
        .tab-button:hover:not(.active) {
            background: #d1d5db;
        }
        
        /* Tab Content */
        .tab-content {
            display: none;
            animation: fadeIn 0.3s;
        }
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Alarm System Styles */
        .controls {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .controls h3 {
            margin-bottom: 15px;
            color: #374151;
        }
        .volume-control {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .volume-control span {
            white-space: nowrap;
            font-weight: 600;
            color: #374151;
        }
        .volume-control input[type="range"] {
            flex: 1;
            height: 6px;
            border-radius: 5px;
            background: #e5e7eb;
            outline: none;
            -webkit-appearance: none;
        }
        .volume-control input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
        }
        .volume-control input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            border: none;
        }
        
        .duration-settings {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid #e5e7eb;
        }
        .duration-settings h4 {
            margin-bottom: 12px;
            color: #374151;
            font-size: 1.1em;
        }
        .duration-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 10px;
        }
        .duration-input {
            text-align: center;
        }
        .duration-input label {
            display: block;
            margin-bottom: 5px;
            font-size: 0.9em;
            font-weight: 600;
            color: #6b7280;
        }
        .duration-input input {
            width: 100%;
            padding: 8px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: bold;
            color: #667eea;
            text-align: center;
            transition: all 0.3s;
        }
        .duration-input input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        .btn-save-duration {
            width: 100%;
            padding: 10px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1em;
        }
        .btn-save-duration:hover {
            background: #2563eb;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(59, 130, 246, 0.3);
        }
        .info-text {
            margin-top: 8px;
            font-size: 0.85em;
            color: #6b7280;
            text-align: center;
        }
        
        /* Court Cards */
        .courts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }
        .court-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }
        .court-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }
        .court-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }
        .court-title {
            font-size: 1.3em;
            font-weight: bold;
            color: #667eea;
        }
        .led-indicator {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #e5e7eb;
            transition: all 0.3s;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }
        .led-indicator.on {
            background: #10b981;
            box-shadow: 0 0 15px #10b981, inset 0 0 5px rgba(255,255,255,0.5);
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        .timer-display {
            text-align: center;
            font-size: 2.5em;
            font-weight: bold;
            color: #667eea;
            font-family: 'Courier New', monospace;
            margin: 20px 0;
            padding: 10px;
            background: #f3f4f6;
            border-radius: 8px;
        }
        .input-group {
            margin: 10px 0;
        }
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #374151;
        }
        .input-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s;
        }
        .input-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        .button-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }
        button {
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.95em;
        }
        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .btn-start {
            background: #10b981;
            color: white;
        }
        .btn-start:hover:not(:disabled) {
            background: #059669;
        }
        .btn-pause {
            background: #f59e0b;
            color: white;
        }
        .btn-pause:hover:not(:disabled) {
            background: #d97706;
        }
        .btn-stop {
            background: #ef4444;
            color: white;
        }
        .btn-stop:hover:not(:disabled) {
            background: #dc2626;
        }
        .btn-settings {
            background: #6b7280;
            color: white;
            grid-column: span 2;
        }
        .btn-settings:hover {
            background: #4b5563;
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }
        
        /* Settings Panel */
        .settings-panel {
            display: none;
            margin-top: 15px;
            padding: 15px;
            background: #f9fafb;
            border-radius: 8px;
            border: 2px solid #e5e7eb;
        }
        .settings-panel.active {
            display: block;
            animation: slideDown 0.3s;
        }
        @keyframes slideDown {
            from { opacity: 0; max-height: 0; }
            to { opacity: 1; max-height: 1000px; }
        }
        
        /* Upload Section */
        .upload-section {
            margin-top: 10px;
            padding: 12px;
            background: #fef3c7;
            border-radius: 8px;
            border: 2px dashed #f59e0b;
        }
        .upload-section label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #92400e;
        }
        .upload-section input[type="file"] {
            width: 100%;
            padding: 8px;
            font-size: 0.9em;
            border: 2px solid #f59e0b;
            border-radius: 6px;
            background: white;
            cursor: pointer;
        }
        .upload-progress {
            margin-top: 8px;
            display: none;
        }
        .progress-bar {
            width: 100%;
            height: 24px;
            background: #e5e7eb;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981 0%, #059669 100%);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.85em;
            font-weight: bold;
        }
        
        /* Stats */
        .stats {
            display: flex;
            justify-content: space-around;
            margin-top: 15px;
            padding: 12px;
            background: #f3f4f6;
            border-radius: 8px;
        }
        .stat-item {
            text-align: center;
        }
        .stat-label {
            font-size: 0.8em;
            color: #6b7280;
            margin-bottom: 4px;
        }
        .stat-value {
            font-size: 1.3em;
            font-weight: bold;
            color: #667eea;
        }
        
        /* WiFi Setup Styles */
        .wifi-container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 600px;
            margin: 0 auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .wifi-container h2 {
            color: #667eea;
            margin-bottom: 20px;
            text-align: center;
        }
        .status {
            text-align: center;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 600;
        }
        .status.connected {
            background: #d1fae5;
            color: #065f46;
            border: 2px solid #10b981;
        }
        .status.disconnected {
            background: #fee2e2;
            color: #991b1b;
            border: 2px solid #ef4444;
        }
        .status-info {
            margin-top: 10px;
            font-size: 0.9em;
        }
        .status-info div {
            margin: 5px 0;
        }
        .section {
            margin-bottom: 25px;
        }
        .section-title {
            font-weight: bold;
            color: #374151;
            margin-bottom: 15px;
            font-size: 1.1em;
        }
        .network-list {
            max-height: 300px;
            overflow-y: auto;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
        }
        .network-item {
            padding: 12px 15px;
            border-bottom: 1px solid #e5e7eb;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .network-item:last-child {
            border-bottom: none;
        }
        .network-item:hover {
            background: #f3f4f6;
        }
        .network-item.selected {
            background: #dbeafe;
            border-left: 4px solid #3b82f6;
        }
        .network-name {
            font-weight: 600;
            color: #1f2937;
        }
        .network-signal {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
            color: #6b7280;
        }
        .signal-bars {
            display: flex;
            gap: 2px;
            align-items: flex-end;
        }
        .signal-bar {
            width: 4px;
            background: #d1d5db;
            border-radius: 2px;
        }
        .signal-bar.active {
            background: #10b981;
        }
        .btn-primary {
            background: #667eea;
            color: white;
            margin-bottom: 10px;
            width: 100%;
            padding: 12px;
        }
        .btn-primary:hover {
            background: #5568d3;
        }
        .btn-secondary {
            background: #6b7280;
            color: white;
            width: 100%;
            padding: 12px;
        }
        .btn-secondary:hover {
            background: #4b5563;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #6b7280;
        }
        .spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            h1 {
                font-size: 1.4em;
            }
            .courts-grid {
                grid-template-columns: 1fr;
            }
            .timer-display {
                font-size: 2em;
            }
            .duration-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔔 SYSTEM CONTROL ALARM LAPANGAN</h1>
        
        <!-- Tab Navigation -->
        <div class="tab-nav">
            <button class="tab-button active" onclick="switchTab('alarm', event)">
                🎮 Control Alarm
            </button>
            <button class="tab-button" onclick="switchTab('wifi', event)">
                📡 WiFi Setup
            </button>
        </div>
        
        <!-- Alarm Control Tab -->
        <div id="alarm-tab" class="tab-content active">
            <div class="controls">
                <h3>⚙️ Pengaturan Global</h3>
                
                <div class="volume-control">
                    <span>🔊 Volume:</span>
                    <input type="range" id="globalVolume" min="0" max="100" value="70">
                    <span id="volumeValue">70%</span>
                </div>
                
                <!-- Duration Settings -->
                <div class="duration-settings">
                    <h4>⏱️ Durasi Alarm & Warning</h4>
                    
                    <div class="duration-grid">
                        <div class="duration-input">
                            <label>🔔 Alarm (detik)</label>
                            <input type="number" id="alarmDuration" min="1" max="60" value="8">
                        </div>
                        
                        <div class="duration-input">
                            <label>⚠️ Warning (detik)</label>
                            <input type="number" id="warningDuration" min="1" max="30" value="5">
                        </div>
                    </div>
                    
                    <button class="btn-save-duration" onclick="saveDuration()">
                        💾 Simpan Durasi
                    </button>
                    
                    <div class="info-text">
                        Durasi saat LED menyala dan audio aktif
                    </div>
                </div>
            </div>

            <div class="courts-grid" id="courtsContainer"></div>
        </div>
        
        <!-- WiFi Setup Tab -->
        <div id="wifi-tab" class="tab-content">
            <div class="wifi-container">
                <h2>🌐 WiFi Setup</h2>
                
                <div class="status" id="status">
                    <div class="loading">
                        <div class="spinner"></div>
                        Memuat status WiFi...
                    </div>
                </div>

                <div class="section">
                    <div class="section-title">📡 Jaringan WiFi Tersedia</div>
                    <button class="btn-secondary" onclick="scanNetworks()" id="btnScan">
                        🔄 Scan Ulang
                    </button>
                    <div class="network-list" id="networkList" style="margin-top: 10px;">
                        <div class="loading">
                            <div class="spinner"></div>
                            Memindai jaringan...
                        </div>
                    </div>
                </div>

                <div class="section">
                    <div class="section-title">🔐 Koneksi WiFi</div>
                    <form onsubmit="connectWiFi(event)">
                        <div class="input-group">
                            <label>SSID:</label>
                            <input type="text" id="ssid" required placeholder="Nama WiFi">
                        </div>
                        <div class="input-group">
                            <label>Password:</label>
                            <input type="password" id="password" placeholder="Password WiFi (kosongkan jika open)">
                        </div>
                        <div class="input-group">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" id="showPass" onclick="togglePassword()"> 
                                <span>Tampilkan Password</span>
                            </label>
                        </div>
                        <button type="submit" class="btn-primary" id="btnConnect">
                            ✅ Simpan & Hubungkan
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '';
        let courts = [];
        let selectedSSID = '';
        let currentTab = 'alarm';

        // Tab Switching
        function switchTab(tab, event) {
            currentTab = tab;
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            event.target.classList.add('active');
            document.getElementById(`${tab}-tab`).classList.add('active');
            
            if (tab === 'wifi') {
                updateWiFiStatus();
                scanNetworks();
            }
        }

        // Format Time
        function formatTime(seconds) {
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = seconds % 60;
            return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
        }

        // Create Court Card
        function createCourtCard(courtId) {
            return `
                <div class="court-card" id="court-${courtId}">
                    <div class="court-header">
                        <div class="court-title">Lapangan ${courtId + 1}</div>
                        <div class="led-indicator" id="led-${courtId}"></div>
                    </div>
                    
                    <div class="timer-display" id="timer-${courtId}">00:00:00</div>
                    
                    <div class="input-group">
                        <label>Durasi (menit):</label>
                        <input type="number" id="duration-${courtId}" value="60" min="1">
                    </div>
                    
                    <div class="input-group">
                        <label>Nama Pemain:</label>
                        <input type="text" id="player-${courtId}" placeholder="Opsional">
                    </div>
                    
                    <div class="button-group">
                        <button class="btn-start" onclick="startTimer(${courtId})">▶️ Mulai</button>
                        <button class="btn-pause" onclick="pauseTimer(${courtId})" disabled id="pause-${courtId}">⏸️ Pause</button>
                        <button class="btn-stop" onclick="stopTimer(${courtId})" disabled id="stop-${courtId}">⏹️ Stop</button>
                        <button class="btn-settings" onclick="toggleSettings(${courtId})">⚙️ Pengaturan</button>
                    </div>
                    
                    <div class="settings-panel" id="settings-${courtId}">
                        <div class="input-group">
                            <label>🔊 Volume Lapangan:</label>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <input type="range" id="volume-${courtId}" min="0" max="100" value="70" 
                                    onchange="updateSettings(${courtId})" style="flex: 1;">
                                <span id="volume-value-${courtId}" style="min-width: 45px; font-weight: bold;">70%</span>
                            </div>
                        </div>
                        
                        <div class="input-group">
                            <label>⏰ Warning (menit sebelum habis):</label>
                            <input type="number" id="warning-${courtId}" value="5" min="1" 
                                onchange="updateSettings(${courtId})">
                        </div>
                        
                        <div class="input-group">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" id="loop-${courtId}" onchange="updateSettings(${courtId})">
                                <span>🔁 Loop alarm hingga di-stop manual</span>
                            </label>
                        </div>
                        
                        <div class="upload-section">
                            <label>🎵 Upload Audio Alarm (.wav):</label>
                            <input type="file" accept="audio/wav,audio/x-wav" onchange="uploadAudio(${courtId}, 'alarm', this)">
                            <div class="upload-progress" id="progress-alarm-${courtId}">
                                <div class="progress-bar">
                                    <div class="progress-fill" id="progress-fill-alarm-${courtId}">0%</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="upload-section">
                            <label>⚠️ Upload Audio Warning (.wav):</label>
                            <input type="file" accept="audio/wav,audio/x-wav" onchange="uploadAudio(${courtId}, 'warning', this)">
                            <div class="upload-progress" id="progress-warning-${courtId}">
                                <div class="progress-bar">
                                    <div class="progress-fill" id="progress-fill-warning-${courtId}">0%</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="stats">
                        <div class="stat-item">
                            <div class="stat-label">Sesi</div>
                            <div class="stat-value" id="sessions-${courtId}">0</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">Total Waktu</div>
                            <div class="stat-value" id="totaltime-${courtId}">0h</div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Load Config
        async function loadConfig() {
            try {
                const response = await fetch(API_BASE + '/api/getConfig');
                const config = await response.json();
                
                document.getElementById('globalVolume').value = config.globalVolume;
                document.getElementById('volumeValue').textContent = config.globalVolume + '%';
                document.getElementById('alarmDuration').value = config.alarmDuration;
                document.getElementById('warningDuration').value = config.warningDuration;
                
                console.log('✅ Config loaded:', config);
            } catch (err) {
                console.error('❌ Error loading config:', err);
            }
        }

        // Save Duration
        async function saveDuration() {
            const alarmDuration = parseInt(document.getElementById('alarmDuration').value);
            const warningDuration = parseInt(document.getElementById('warningDuration').value);
            
            if (alarmDuration < 1 || alarmDuration > 60) {
                alert('❌ Durasi alarm harus 1-60 detik');
                return;
            }
            
            if (warningDuration < 1 || warningDuration > 30) {
                alert('❌ Durasi warning harus 1-30 detik');
                return;
            }
            
            try {
                const response = await fetch(API_BASE + '/api/setDuration', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        alarmDuration: alarmDuration,
                        warningDuration: warningDuration
                    })
                });
                
                if (response.ok) {
                    alert('✅ Durasi alarm berhasil disimpan!\n\n' +
                          '🔔 Alarm: ' + alarmDuration + ' detik\n' +
                          '⚠️ Warning: ' + warningDuration + ' detik');
                } else {
                    const error = await response.text();
                    alert('❌ Gagal menyimpan: ' + error);
                }
            } catch (err) {
                alert('❌ Error: ' + err.message);
            }
        }

        // Initialize
        function init() {
            const container = document.getElementById('courtsContainer');
            for (let i = 0; i < 4; i++) {
                container.innerHTML += createCourtCard(i);
            }
            
            loadConfig();
            updateStatus();
            setInterval(updateStatus, 1000);
        }

        // Update Status
        async function updateStatus() {
            if (currentTab !== 'alarm') return;
            
            try {
                const response = await fetch(API_BASE + '/api/status');
                const data = await response.json();
                
                data.forEach(court => {
                    document.getElementById(`timer-${court.id}`).textContent = formatTime(court.remaining);
                    
                    const led = document.getElementById(`led-${court.id}`);
                    if (court.isRunning) {
                        led.classList.add('on');
                    } else {
                        led.classList.remove('on');
                    }
                    
                    document.getElementById(`pause-${court.id}`).disabled = !court.isRunning;
                    document.getElementById(`stop-${court.id}`).disabled = !court.isRunning;
                    
                    document.getElementById(`sessions-${court.id}`).textContent = court.sessionCount;
                    document.getElementById(`totaltime-${court.id}`).textContent = 
                        Math.floor(court.totalPlayTime / 3600) + 'h';
                });
            } catch (err) {
                console.error('❌ Error updating status:', err);
            }
        }

        // Start Timer
        async function startTimer(courtId) {
            const duration = document.getElementById(`duration-${courtId}`).value;
            const playerName = document.getElementById(`player-${courtId}`).value;
            
            if (!duration || duration < 1) {
                alert('❌ Masukkan durasi yang valid!');
                return;
            }
            
            try {
                const response = await fetch(API_BASE + '/api/start', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({courtId, duration: parseInt(duration), playerName})
                });
                
                if (response.ok) {
                    console.log(`✅ Timer started for Court ${courtId + 1}`);
                } else {
                    alert('❌ Gagal memulai timer');
                }
            } catch (err) {
                alert('❌ Error starting timer: ' + err.message);
            }
        }

        // Pause Timer
        async function pauseTimer(courtId) {
            try {
                await fetch(API_BASE + '/api/pause', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({courtId})
                });
            } catch (err) {
                alert('❌ Error pausing timer');
            }
        }

        // Stop Timer
        async function stopTimer(courtId) {
            if (!confirm('⚠️ Yakin ingin menghentikan timer?')) {
                return;
            }
            
            try {
                await fetch(API_BASE + '/api/stop', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({courtId})
                });
            } catch (err) {
                alert('❌ Error stopping timer');
            }
        }

        // Toggle Settings
        function toggleSettings(courtId) {
            const panel = document.getElementById(`settings-${courtId}`);
            panel.classList.toggle('active');
        }

        // Update Settings
        async function updateSettings(courtId) {
            const volume = document.getElementById(`volume-${courtId}`).value;
            const warningTime = document.getElementById(`warning-${courtId}`).value;
            const loopAlarm = document.getElementById(`loop-${courtId}`).checked;
            
            document.getElementById(`volume-value-${courtId}`).textContent = volume + '%';
            
            try {
                await fetch(API_BASE + '/api/settings', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        courtId,
                        volume: parseInt(volume),
                        warningTime: parseInt(warningTime),
                        loopAlarm
                    })
                });
            } catch (err) {
                console.error('❌ Error updating settings');
            }
        }

        // Upload Audio with Enhanced Security
        async function uploadAudio(courtId, type, fileInput) {
            const file = fileInput.files[0];
            if (!file) return;
            
            // ✅ Validate file extension (strict)
            const fileName = file.name.toLowerCase();
            if (!fileName.endsWith('.wav')) {
                alert('❌ Format tidak didukung!\n\n' +
                      '✓ Hanya file .wav yang diperbolehkan\n' +
                      '✗ File Anda: ' + file.name);
                fileInput.value = '';
                return;
            }
            
            // ✅ Validate MIME type
            const validTypes = ['audio/wav', 'audio/x-wav', 'audio/wave'];
            const isValidMime = validTypes.includes(file.type) || file.type === '';
            if (!isValidMime && file.type !== 'application/octet-stream') {
                alert('❌ MIME type tidak valid!\n\n' +
                      'Expected: audio/wav\n' +
                      'Got: ' + file.type);
                fileInput.value = '';
                return;
            }
            
            // ✅ Validate file size (max 10MB)
            const maxSize = 10 * 1024 * 1024;
            if (file.size > maxSize) {
                alert('❌ File terlalu besar!\n\n' +
                      '✓ Maksimal: 10MB\n' +
                      '✗ Ukuran file: ' + (file.size / 1024 / 1024).toFixed(2) + ' MB');
                fileInput.value = '';
                return;
            }
            
            // ✅ Validate file size minimum (at least 1KB)
            if (file.size < 1024) {
                alert('❌ File terlalu kecil!\n\n' +
                      'Minimal 1KB untuk audio WAV yang valid');
                fileInput.value = '';
                return;
            }
            
            // ✅ Validate filename (security check)
            const expectedFilename = type + (courtId + 1) + '.wav';
            if (fileName.includes('..') || fileName.includes('/') || fileName.includes('\\')) {
                alert('❌ Nama file tidak valid!\n\n' +
                      'File akan disimpan sebagai: ' + expectedFilename);
            }
            
            // Show progress
            const progressDiv = document.getElementById(`progress-${type}-${courtId}`);
            const progressFill = document.getElementById(`progress-fill-${type}-${courtId}`);
            progressDiv.style.display = 'block';
            progressFill.style.width = '0%';
            progressFill.textContent = '⏳ 0%';
            
            const formData = new FormData();
            formData.append('file', file, expectedFilename);
            
            try {
                // ✅ Progress simulation with timeout
                let progress = 0;
                const progressInterval = setInterval(() => {
                    progress += 10;
                    if (progress <= 90) {
                        progressFill.style.width = progress + '%';
                        progressFill.textContent = '⏳ ' + progress + '%';
                    }
                }, 200);
                
                // ✅ Upload with timeout
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 30000); // 30s timeout
                
                const response = await fetch(API_BASE + '/api/upload', {
                    method: 'POST',
                    body: formData,
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                clearInterval(progressInterval);
                
                if (response.ok) {
                    // ✅ Parse response
                    const contentType = response.headers.get('content-type');
                    let result;
                    
                    if (contentType && contentType.includes('application/json')) {
                        result = await response.json();
                    } else {
                        result = { message: await response.text() };
                    }
                    
                    progressFill.style.width = '100%';
                    progressFill.textContent = '✅ 100%';
                    
                    setTimeout(() => {
                        alert('✅ Audio berhasil diupload!\n\n' +
                              '📄 File: ' + expectedFilename + '\n' +
                              '📦 Size: ' + (file.size / 1024).toFixed(2) + ' KB\n' +
                              '✓ Verified: OK');
                        progressDiv.style.display = 'none';
                        fileInput.value = '';
                    }, 500);
                } else if (response.status === 413) {
                    throw new Error('File terlalu besar (max 10MB)');
                } else {
                    const errorText = await response.text();
                    throw new Error(errorText || 'Upload failed');
                }
            } catch (err) {
                progressDiv.style.display = 'none';
                
                let errorMsg = '❌ Error uploading audio:\n\n';
                if (err.name === 'AbortError') {
                    errorMsg += '⏱️ Upload timeout (max 30 detik)\n' +
                               'File terlalu besar atau koneksi lambat';
                } else {
                    errorMsg += err.message;
                }
                
                alert(errorMsg);
                fileInput.value = '';
                console.error('Upload error:', err);
            }
        }

        // Global Volume Control
        document.getElementById('globalVolume').addEventListener('input', async (e) => {
            const value = e.target.value;
            document.getElementById('volumeValue').textContent = value + '%';
            
            try {
                await fetch(API_BASE + '/api/globalVolume', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({volume: parseInt(value)})
                });
            } catch (err) {
                console.error('❌ Error updating global volume');
            }
        });

        // WiFi Functions
        function getSignalStrength(rssi) {
            if (rssi >= -50) return 4;
            if (rssi >= -60) return 3;
            if (rssi >= -70) return 2;
            return 1;
        }

        function createSignalBars(rssi) {
            const strength = getSignalStrength(rssi);
            let html = '<div class="signal-bars">';
            for (let i = 1; i <= 4; i++) {
                const height = i * 3 + 2;
                const active = i <= strength ? 'active' : '';
                html += `<div class="signal-bar ${active}" style="height: ${height}px;"></div>`;
            }
            html += '</div>';
            return html;
        }

        async function updateWiFiStatus() {
            try {
                const response = await fetch(API_BASE + '/api/wifi/status');
                const data = await response.json();
                
                const statusDiv = document.getElementById('status');
                
                if (data.connected) {
                    statusDiv.className = 'status connected';
                    statusDiv.innerHTML = `
                        <div style="font-size: 1.2em; font-weight: bold;">✅ Terhubung ke WiFi</div>
                        <div class="status-info">
                            <div>📡 SSID: <strong>${data.ssid}</strong></div>
                            <div>🌐 IP: <strong>${data.ip}</strong></div>
                            <div>📶 Signal: <strong>${data.rssi} dBm</strong></div>
                            <div>🏷️ Hostname: <strong>${data.hostname}</strong></div>
                        </div>
                    `;
                } else {
                    statusDiv.className = 'status disconnected';
                    statusDiv.innerHTML = `
                        <div style="font-size: 1.2em; font-weight: bold;">❌ Tidak Terhubung</div>
                        <div class="status-info">
                            <div>📶 Mode: <strong>Access Point</strong></div>
                            <div>📡 AP SSID: <strong>${data.ap_ssid}</strong></div>
                            <div>🌐 AP IP: <strong>${data.ap_ip}</strong></div>
                            <div>👥 Clients: <strong>${data.clients}</strong></div>
                            ${data.saved_ssid ? `<div>💾 Tersimpan: <strong>${data.saved_ssid}</strong></div>` : ''}
                        </div>
                    `;
                }
            } catch (err) {
                console.error('❌ Error getting WiFi status:', err);
            }
        }

        async function scanNetworks() {
            const networkList = document.getElementById('networkList');
            const btnScan = document.getElementById('btnScan');
            
            btnScan.disabled = true;
            btnScan.textContent = '⏳ Memindai...';
            
            networkList.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    Memindai jaringan WiFi...
                </div>
            `;
            
            try {
                const response = await fetch(API_BASE + '/api/wifi/scan');
                const networks = await response.json();
                
                if (networks.length === 0) {
                    networkList.innerHTML = '<div class="loading">❌ Tidak ada jaringan ditemukan</div>';
                } else {
                    networkList.innerHTML = '';
                    networks.forEach(network => {
                        const item = document.createElement('div');
                        item.className = 'network-item';
                        item.onclick = () => selectNetwork(network.ssid);
                        item.innerHTML = `
                            <div class="network-name">📡 ${network.ssid}</div>
                            <div class="network-signal">
                                ${createSignalBars(network.rssi)}
                                <span>${network.encryption}</span>
                            </div>
                        `;
                        networkList.appendChild(item);
                    });
                }
            } catch (err) {
                networkList.innerHTML = '<div class="loading">❌ Gagal memindai jaringan</div>';
                console.error('❌ Error scanning networks:', err);
            }
            
            btnScan.disabled = false;
            btnScan.textContent = '🔄 Scan Ulang';
        }

        function selectNetwork(ssid) {
            selectedSSID = ssid;
            document.getElementById('ssid').value = ssid;
            
            document.querySelectorAll('.network-item').forEach(item => {
                item.classList.remove('selected');
                if (item.querySelector('.network-name').textContent.includes(ssid)) {
                    item.classList.add('selected');
                }
            });
        }

        async function connectWiFi(event) {
            event.preventDefault();
            
            const ssid = document.getElementById('ssid').value;
            const password = document.getElementById('password').value;
            const btnConnect = document.getElementById('btnConnect');
            
            if (!ssid) {
                alert('❌ Masukkan SSID WiFi!');
                return;
            }
            
            if (!confirm(`🔌 Hubungkan ke WiFi "${ssid}"?\n\n⚠️ ESP32 akan restart dan mencoba terhubung.\n\nSetelah berhasil, akses via:\n• http://system-alarm.local\n• http://192.168.1.100`)) {
                return;
            }
            
            btnConnect.disabled = true;
            btnConnect.textContent = '⏳ Menyimpan...';
            
            try {
                const response = await fetch(API_BASE + '/api/wifi/connect', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ssid, password})
                });
                
                if (response.ok) {
                    alert('✅ Kredensial WiFi disimpan!\n\n' +
                          '🔄 ESP32 akan restart...\n\n' +
                          '✓ Jika berhasil terhubung:\n' +
                          '  • http://system-alarm.local\n' +
                          '  • http://192.168.1.100\n\n' +
                          '✗ Jika gagal:\n' +
                          '  ESP32 akan kembali ke mode AP');
                } else {
                    alert('❌ Gagal menyimpan kredensial WiFi');
                    btnConnect.disabled = false;
                    btnConnect.textContent = '✅ Simpan & Hubungkan';
                }
            } catch (err) {
                alert('❌ Error: ' + err.message);
                btnConnect.disabled = false;
                btnConnect.textContent = '✅ Simpan & Hubungkan';
            }
        }

        function togglePassword() {
            const passInput = document.getElementById('password');
            const showPass = document.getElementById('showPass');
            passInput.type = showPass.checked ? 'text' : 'password';
        }

        // Initialize on load
        window.addEventListener('load', () => {
            init();
        });
    </script>
</body>
</html>